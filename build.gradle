import groovy.json.JsonSlurper
import java.util.regex.Pattern
import java.util.regex.Matcher

task buildChangelog {
  def fileContents = ""
  def stringsFile = new File("./build/changelog.md")

  def pageNumber = 1

  def orgName = 'openhab'
  def openHABMilestone = '2.2'
  def legacyMilestone = '1.11.0'

  def repos = [
    [
      'name': "openhab2-addons",
      'milestone': "${openHABMilestone}",
      'description': '2.x Addons',
      'types': [ 
        [
          'name':'newbinding',
          'description':"The following add-ons are newly introduced with the ${openHABMilestone} release:"
        ],[
          'name':'enhancement',
          'description':'Enhancements on existing 2.x addons'
        ],[
          'name':'bug',
          'description':'Bug fixes on exisiting 2.x addons'
        ]
      ]
    ],[
      'name': "openhab1-addons",
      'description': '1.x Addons',
      'milestone': "${legacyMilestone}",
      'types': [
        [
          'name':'enhancement',
          'description':'Enhancements on existing 1.x addons'
        ],[
          'name':'bug',
          'description':'Bug fixes on exisiting 1.x addons'
        ]
      ]
    ]
  ]

  repos.each { repo ->

    def repoName = repo.name
    def milestone = repo.milestone
  
    fileContents = fileContents + "## ${repo.description}\n\n"
  
    repo.types.each { type ->

      def pullType = type.name

      fileContents = fileContents + "### ${type.description}\n\n"
  
      def curlOutput = new ByteArrayOutputStream()

      exec {
        commandLine 'curl', "https://api.github.com/search/issues?q=repo:${orgName}/${repoName}%20is:pr%20is:merged%20label:${pullType}%20milestone:%22${milestone}%22&per_page=100"
        standardOutput = curlOutput;
      }
      
      def jsonSluper = new JsonSlurper()
      def searchResults = jsonSluper.parseText(curlOutput.toString())
      def pullRequests = searchResults.items
      def sortedRequests = pullRequests.sort { it.title.toLowerCase() }

      def prevBinding = ""

      sortedRequests.each { pullRequest ->

        def pullTitle = pullRequest.title
        def pullAuthor =  pullRequest.user.login
        def pullNumber = pullRequest.number
        def pullURL = pullRequest.url

        Pattern pattern = Pattern.compile("\\[(.*?)\\](.*)")
        Matcher matcher = pattern.matcher(pullTitle)

        if (matcher.find()) {
          def bindingName = matcher.group(1)
          if (bindingName != prevBinding) {
            fileContents = fileContents + "\n#### ${bindingName}\n\n"
            prevBinding = bindingName
          }
          pullTitle = matcher.group(2)
        }

        fileContents = fileContents + " - #[${pullNumber}](${pullURL}) - ${pullTitle} (@${pullAuthor})\n"
      }
      fileContents = fileContents + "\n"
    }
  }
  stringsFile.text = fileContents
}
